# Unified workflow to build all firmware variants and upload to GitHub Releases
# This workflow builds firmware for all UC2 board variants and creates releases

name: Build and Release All Firmware

on:
  push:
    branches:
      - 'main'
    tags:
      - 'v*'  # Trigger on version tags like v1.0, v1.9, etc.
  pull_request:
    branches:
      - 'main'
  workflow_dispatch:
    inputs:
      git-ref:
        description: 'Git ref (optional)'
        required: false
      release-tag:
        description: 'Release tag (e.g., v1.9)'
        required: false

env:
  GITHUB_REPO: 'youseetoo/uc2-esp32'

jobs:
  build-all-firmware:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # UC2 Standalone boards
          - env_name: UC2_2
            display_name: "UC2 Standalone V2"
            board_id: "esp32-uc2-standalone-2"
            chip_family: "ESP32"
          - env_name: UC2_3
            display_name: "UC2 Standalone V3"
            board_id: "esp32-uc2-standalone-3"
            chip_family: "ESP32"
          - env_name: UC2_4
            display_name: "UC2 Standalone V4"
            board_id: "esp32-uc2-standalone-4"
            chip_family: "ESP32"
          - env_name: UC2_4_CAN
            display_name: "UC2 V4 CAN Master"
            board_id: "esp32-uc2-v4-can"
            chip_family: "ESP32"
          - env_name: UC2_4_CAN_HYBRID
            display_name: "UC2 V4 CAN Hybrid"
            board_id: "esp32-uc2-v4-can-hybrid"
            chip_family: "ESP32"
          - env_name: UC2_WEMOS
            display_name: "UC2 WEMOS D1 R32"
            board_id: "esp32-uc2-wemos"
            chip_family: "ESP32"
          # Seeed Xiao boards
          - env_name: seeed_xiao_esp32s3
            display_name: "Xiao ESP32S3 ODMR"
            board_id: "seeed_xiao_esp32s3"
            chip_family: "ESP32-S3"
          - env_name: seeed_xiao_esp32s3_ledservo
            display_name: "Xiao LED & Servo"
            board_id: "seeed_xiao_esp32s3_ledservo"
            chip_family: "ESP32-S3"
          - env_name: seeed_xiao_esp32s3_ledring
            display_name: "Xiao LED Ring"
            board_id: "seeed_xiao_esp32s3_ledring"
            chip_family: "ESP32-S3"
          # CAN Slave boards
          - env_name: seeed_xiao_esp32s3_can_slave_motor
            display_name: "Xiao CAN Slave Motor"
            board_id: "xiao-can-slave-motor"
            chip_family: "ESP32-S3"
          - env_name: seeed_xiao_esp32s3_can_slave_galvo
            display_name: "Xiao CAN Slave Galvo"
            board_id: "xiao-can-slave-galvo"
            chip_family: "ESP32-S3"
          - env_name: seeed_xiao_esp32s3_can_slave_laser
            display_name: "Xiao CAN Slave Laser"
            board_id: "xiao-can-slave-laser"
            chip_family: "ESP32-S3"
          - env_name: seeed_xiao_esp32s3_can_slave_led
            display_name: "Xiao CAN Slave LED"
            board_id: "xiao-can-slave-led"
            chip_family: "ESP32-S3"
          - env_name: seeed_xiao_esp32s3_can_slave_illumination
            display_name: "Xiao CAN Slave Illumination"
            board_id: "xiao-can-slave-illumination"
            chip_family: "ESP32-S3"
          # HAT boards
          - env_name: UC2_3_CAN_HAT_Master_v2
            display_name: "CAN HAT Master V2"
            board_id: "can-hat-master-v2"
            chip_family: "ESP32"
          # Waveshare
          - env_name: waveshare_esp32s3_ledarray
            display_name: "Waveshare ESP32S3 Matrix"
            board_id: "waveshare_esp32s3_ledarray"
            chip_family: "ESP32-S3"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git-ref || github.ref }}
          submodules: recursive

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
            ~/.platformio/packages
          key: ${{ runner.os }}-pio-${{ matrix.env_name }}-${{ hashFiles('platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ matrix.env_name }}-
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO and tools
        run: |
          python -m pip install --upgrade pip
          pip install platformio esptool

      - name: Build firmware
        id: build
        run: |
          set -e
          echo "==> Building ${{ matrix.env_name }}"
          
          # Try to build, skip if environment doesn't exist
          if ! pio run --environment "${{ matrix.env_name }}"; then
            echo "::warning::Build failed or environment not found for ${{ matrix.env_name }}"
            echo "build_success=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "build_success=true" >> $GITHUB_OUTPUT
          
          BIN_DIR=".pio/build/${{ matrix.env_name }}"
          mkdir -p build/fw-images
          
          # Get version from tag or commit
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Determine chip type and merge binaries appropriately
          CHIP="${{ matrix.chip_family }}"
          BOARD_ID="${{ matrix.board_id }}"
          
          if [[ "$CHIP" == "ESP32-S3" ]]; then
            CHIP_ARG="esp32s3"
            BOOT_ADDR="0x0"
          else
            CHIP_ARG="esp32"
            BOOT_ADDR="0x1000"
          fi
          
          # Merge all binaries into a single flashable file
          if [[ -f "$BIN_DIR/bootloader.bin" && -f "$BIN_DIR/partitions.bin" && -f "$BIN_DIR/firmware.bin" ]]; then
            echo "==> Merging binaries for ${{ matrix.env_name }}"
            
            # Find boot_app0.bin
            BOOT_APP0=$(find ~/.platformio -name "boot_app0.bin" | head -1)
            
            python -m esptool \
              --chip "$CHIP_ARG" \
              merge_bin \
              -o "build/fw-images/${BOARD_ID}.bin" \
              --flash_mode dio \
              --flash_freq 40m \
              --flash_size 4MB \
              $BOOT_ADDR "$BIN_DIR/bootloader.bin" \
              0x8000 "$BIN_DIR/partitions.bin" \
              0xe000 "$BOOT_APP0" \
              0x10000 "$BIN_DIR/firmware.bin"
          else
            # Fallback: just copy firmware.bin
            cp "$BIN_DIR/firmware.bin" "build/fw-images/${BOARD_ID}.bin"
          fi
          
          # Create manifest.json for ESP Web Tools
          cat > "build/fw-images/${BOARD_ID}-manifest.json" << EOF
          {
            "name": "${{ matrix.display_name }}",
            "version": "$VERSION",
            "home_assistant_domain": "UC2-ESP32",
            "funding_url": "https://github.com/${{ env.GITHUB_REPO }}",
            "builds": [
              {
                "chipFamily": "$CHIP",
                "parts": [{ "path": "${BOARD_ID}.bin", "offset": 0 }]
              }
            ]
          }
          EOF

      - name: Upload firmware artifact
        if: steps.build.outputs.build_success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board_id }}
          path: build/fw-images/
          retention-days: 30

  # Collect all firmware and create release
  create-release:
    needs: build-all-firmware
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: firmware
          pattern: firmware-*
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "Downloaded firmware files:"
          ls -la firmware/

      - name: Get release info
        id: release_info
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Create firmware index JSON
        run: |
          cd firmware
          cat > firmware-index.json << 'INDEXEOF'
          {
            "version": "${{ steps.release_info.outputs.tag }}",
            "generated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ env.GITHUB_REPO }}",
            "firmware": [
          INDEXEOF
          
          # Generate firmware entries
          first=true
          for manifest in *-manifest.json; do
            if [ -f "$manifest" ]; then
              board_id="${manifest%-manifest.json}"
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> firmware-index.json
              fi
              name=$(jq -r '.name' "$manifest")
              chip=$(jq -r '.builds[0].chipFamily' "$manifest")
              cat >> firmware-index.json << EOF
              {
                "id": "$board_id",
                "name": "$name",
                "chipFamily": "$chip",
                "manifest": "${board_id}-manifest.json",
                "binary": "${board_id}.bin"
              }
          EOF
            fi
          done
          
          echo "]}" >> firmware-index.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: "Firmware Release ${{ steps.release_info.outputs.tag }}"
          body: |
            ## UC2 Firmware Release ${{ steps.release_info.outputs.tag }}
            
            ### Available Firmware
            Download the firmware for your board and flash it using the [UC2 Web Flasher](https://youseetoo.github.io).
            
            ### Firmware Files
            - `*.bin` - Merged firmware binaries ready for flashing
            - `*-manifest.json` - ESP Web Tools manifest files
            - `firmware-index.json` - Index of all available firmware
            
            ### Flash Instructions
            1. Go to https://youseetoo.github.io
            2. Select your board
            3. Select this release version
            4. Click "Install"
          files: |
            firmware/*.bin
            firmware/*-manifest.json
            firmware/firmware-index.json
          draft: false
          prerelease: ${{ contains(steps.release_info.outputs.tag, 'beta') || contains(steps.release_info.outputs.tag, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Update latest release pointer for the web flasher
  update-latest:
    needs: create-release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'beta') && !contains(github.ref, 'alpha')
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Update latest version file
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "$TAG" > LATEST_VERSION
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add LATEST_VERSION
          git commit -m "Update LATEST_VERSION to $TAG" || true
          git push || true

  # Deploy manifests to youseetoo.github.io to avoid CORS issues
  deploy-to-website:
    needs: create-release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: firmware
          pattern: firmware-*
          merge-multiple: true

      - name: Get release info
        id: release_info
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
      - name: Checkout youseetoo.github.io
        uses: actions/checkout@v4
        with:
          repository: youseetoo/youseetoo.github.io
          path: website
          token: ${{ secrets.API_TOKEN_GITHUB }}
          
      - name: Deploy manifests and binaries
        shell: bash
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          
          # Create version-specific directory
          mkdir -p "website/static/firmware/${TAG}"
          mkdir -p "website/static/firmware/latest"
          
          # Copy all manifests and binaries to version directory
          cp firmware/*.json "website/static/firmware/${TAG}/"
          cp firmware/*.bin "website/static/firmware/${TAG}/"
          
          # Update manifests to use relative paths (same directory)
          cd "website/static/firmware/${TAG}"
          for manifest in *-manifest.json; do
            if [ -f "$manifest" ]; then
              # Extract board ID
              board_id="${manifest%-manifest.json}"
              # Update path in manifest to be relative
              jq --arg board "$board_id" '.builds[0].parts[0].path = ($board + ".bin")' "$manifest" > "${manifest}.tmp"
              mv "${manifest}.tmp" "$manifest"
            fi
          done
          
          # For non-beta/alpha releases, also update 'latest'
          if [[ ! "$TAG" =~ (beta|alpha) ]]; then
            cp *.json "../../latest/"
            cp *.bin "../../latest/"
          fi
          
      - name: Commit and push
        shell: bash
        run: |
          cd website
          git config user.email 'bene.d@gmx.de'
          git config user.name 'beniroquai'
          
          if git status --porcelain | grep -q '^??\|^ M'; then
            git add static/firmware
            git commit -m "Deploy firmware ${{ steps.release_info.outputs.tag }} => https://github.com/youseetoo/uc2-esp32"
            git push
          else
            echo "No changes to commit"
          fi

        uses: actions/checkout@v4
        
      - name: Update latest version file
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "$TAG" > LATEST_VERSION
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add LATEST_VERSION
          git commit -m "Update LATEST_VERSION to $TAG" || true
          git push || true
